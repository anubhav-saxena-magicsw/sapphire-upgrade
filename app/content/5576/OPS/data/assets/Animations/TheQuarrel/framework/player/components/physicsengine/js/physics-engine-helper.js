define([basePath+"framework/libs/easeljs/easeljs-0.7.0.min.js",basePath+"framework/libs/box2d/box2d-web-2.1.a.3.min.js","components/physicsengine/js/circle-body","components/physicsengine/js/rectangle-body"],function(e,t,s,i){var o=function(e){this.BOX2D={b2Vec2:Box2D.Common.Math.b2Vec2,b2Color:Box2D.Common.b2Color,b2AABB:Box2D.Collision.b2AABB,b2BodyDef:Box2D.Dynamics.b2BodyDef,b2Body:Box2D.Dynamics.b2Body,b2FixtureDef:Box2D.Dynamics.b2FixtureDef,b2Fixture:Box2D.Dynamics.b2Fixture,b2World:Box2D.Dynamics.b2World,b2MassData:Box2D.Collision.Shapes.b2MassData,b2PolygonShape:Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape:Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw:Box2D.Dynamics.b2DebugDraw,b2MouseJointDef:Box2D.Dynamics.Joints.b2MouseJointDef,b2ContactListener:Box2D.Dynamics.b2ContactListener,b2WorldManifold:Box2D.Collision.b2WorldManifold},this.members={},this.members.objXml=e,this.members.fps=isNaN(e.world.fps)===!1?60:Number(e.world.fps),this.members.dynaCount=0,this.members.staCount=0,this.members.bodies={},this.members.maxX=e.world.width,this.members.maxY=e.world.height,this.members.scale=isNaN(e.world.scale)===!1?30:Number(e.world.scale)};return o.prototype.setParent=function(e){this.members.parent=e},o.prototype.setStage=function(){var e=this;this.members.stage=new createjs.Stage(this.members.canId),this.members.tickListener=function(){e.update()},createjs.Ticker.addEventListener("tick",this.members.tickListener),createjs.Ticker.setFPS(60),createjs.Ticker.useRAF=!0},o.prototype.setWorld=function(e){var t,s,i,o;this.members.canId=e,t=this.members.objXml,i=Number(t.world.gravityX),(isNaN(i)||void 0===i)&&(i=0),o=Number(t.world.gravityY),(isNaN(o)||void 0===o)&&(o=0),s=new this.BOX2D.b2Vec2(i,o),this.members.b2World=new this.BOX2D.b2World(s,!0),this.setStage(),this.setStaticBodies(t)},o.prototype.setStaticBodies=function(e){var t,s,i,o;if(i=[],t=e.world.staticBodies,void 0!==t.sta)if(t.sta instanceof Array)for(o=0;o<t.sta.length;o+=1)i.push(t.sta[o]);else i.push(t.sta);for(o=0;o<i.length;o+=1)s=i[o],this.addStaticBody(s);this.setDynamicBodies(e)},o.prototype.setDynamicBodies=function(e){var t,s,i,o;if(i=[],t=e.world.dynamicBodies,void 0!==t.dyna)if(t.dyna instanceof Array)for(o=0;o<t.dyna.length;o+=1)i.push(t.dyna[o]);else i.push(t.dyna);for(o=0;o<i.length;o+=1)s=i[o],this.addDynamicBody(s);this.setDebugDraw(e)},o.prototype.addStaticBody=function(e){void 0===e.myName&&(e.myName="sta"),this.addBody(e)},o.prototype.addDynamicBody=function(e){void 0===e.myName&&(e.myName="dyna"),this.addBody(e)},o.prototype.addBody=function(e){var t,o,r,a;t={},a=Number(this.members.objXml.world.scale),"dyna"===e.myName?(o=this.BOX2D.b2Body.b2_dynamicBody,t.userData={id:"dyna_"+this.members.dynaCount,sleepKill:"true"===e.sleepKill||e.sleepKill===!0?!0:!1,kill:!1,killOnOut:"false"===e.killOnOut||e.killOnOut===!1?!1:!0,absorb:"true"===e.absorb||e.absorb===!0?!0:!1,collideOnce:"true"===e.collideOnce||e.collideOnce===!0?!0:!1,type:"dynamic"},this.members.dynaCount+=1,t.grpIndex="false"===this.members.objXml.world.dynamicBodies.mutualCollision?-1:0):(o=this.BOX2D.b2Body.b2_staticBody,t.userData={id:"sta_"+this.members.staCount,sleepKill:"true"===e.sleepKill||e.sleepKill===!0?!0:!1,kill:!1,killOnOut:"false"===e.killOnOut||e.killOnOut===!1?!1:!0,absorb:"true"===e.absorb||e.absorb===!0?!0:!1,type:"static"},this.members.staCount+=1,t.grpIndex=0),void 0!==e.id&&(t.userData.id=e.id+"_"+t.userData.id),t.shapeType="rectangle"===e.shapeType?"rectangle":"circle",t.canWid=Number(this.members.objXml.world.width),t.canHit=Number(this.members.objXml.world.height),t.speedX=void 0===e.speedX?0:Number(e.speedX),t.speedY=void 0===e.speedY?0:Number(e.speedY),t.velocity={x:t.speedX,y:t.speedY},"true"===this.members.objXml.world.dynamicBodies.constantSpeed&&(t.userData.speed=t.velocity),t.density=isNaN(e.density)?0:Number(e.density),t.friction=isNaN(e.friction)?0:Number(e.friction),t.restitution=isNaN(e.restitution)?0:Number(e.restitution),void 0!==e.imgSrc?(t.bitmap=new createjs.Bitmap(e.imgSrc),this.members.stage.addChild(t.bitmap)):t.color=void 0===e.color?"#FFFFFF":e.color,"circle"===t.shapeType?(t.rad=isNaN(e.radius)?0:Number(e.radius)/a,t.xpos=isNaN(e.x)?(t.rad*a+Math.random()*(t.canWid-t.rad*a))/a:Number(e.x)/a,t.ypos=isNaN(e.y)?(t.rad*a+Math.random()*(t.canHit-t.rad*a))/a:Number(e.y)/a,t.position={x:t.xpos,y:t.ypos},r=new s(this.BOX2D),void 0!==t.bitmap?(t.bitmap.regX=t.rad*a,t.bitmap.regY=t.rad*a,r.setRadius(t.rad,t.bitmap)):(t.createjsObj=new createjs.Shape,this.members.stage.addChild(t.createjsObj),t.createjsObj.regX=t.rad*a,t.createjsObj.regY=t.rad*a,t.createjsObj.graphics.beginFill(t.color),t.createjsObj.graphics.drawCircle(t.createjsObj.regX,t.createjsObj.regY,t.rad*a),r.setRadius(t.rad,t.createjsObj))):"rectangle"===t.shapeType&&(t.size={width:"undefined"===e.width?0:Number(e.width)/2/a,height:"undefined"===e.height?0:Number(e.height)/2/a},t.xpos=isNaN(e.x)?(t.size.width*a+Math.random()*(t.canWid-t.size.width*a))/a:Number(e.x)/a,t.ypos=isNaN(e.y)?(t.size.height*a+Math.random()*(t.canHit-t.size.height*a))/a:Number(e.y)/a,t.position={x:t.xpos,y:t.ypos},r=new i(this.BOX2D),void 0!==t.bitmap?(t.bitmap.regX=t.size.width*a,t.bitmap.regY=t.size.height*a,r.setSize(t.size,new createjs.Bitmap(e.imgSrc))):(t.createjsObj=new createjs.Shape,this.members.stage.addChild(t.createjsObj),t.createjsObj.regX=(t.position.x+t.size.width)*a,t.createjsObj.regY=(t.position.y+t.size.height)*a,t.createjsObj.graphics.beginFill(t.color),t.createjsObj.graphics.drawRect(t.position.x*a,t.position.y*a,2*t.size.width*a,2*t.size.height*a),r.setSize(t.size,t.createjsObj))),t.sensor="true"===e.sensor||e.sensor===!0?!0:!1,t.userData.sensor=t.sensor,r.setPosition(t.position),r.setUserData(t.userData),r.setLinearVelocity(t.velocity),r.setType(o),r.setDensity(t.density),r.setFriction(t.friction),r.setRestitution(t.restitution),r.setGroupIndex(t.grpIndex),r.createInWorld(this.members.b2World),this.members.bodies[r.getUserData().id]=r},o.prototype.setDebugDraw=function(){var e,t;e=new this.BOX2D.b2DebugDraw,e.SetSprite(document.getElementById(this.members.canId).getContext("2d")),e.SetDrawScale(30),e.SetFillAlpha(1),e.SetLineThickness(1),e.SetFlags(this.BOX2D.b2DebugDraw.e_shapeBit||this.BOX2D.b2DebugDraw.e_jointBit),this.members.b2World.SetDebugDraw(e),t=this,this.setContactlistner()},o.prototype.collisionInformer=function(e){var t,s,i,o,r,a={};t=this,i=new this.BOX2D.b2WorldManifold,e.GetWorldManifold(i),o=i.m_points[0].x*this.members.scale,r=i.m_points[0].y*this.members.scale,a.touchPoint={x:o,y:r},s=e.GetFixtureA().GetBody().GetUserData(),a.BodyA=s.id,s=e.GetFixtureB().GetBody().GetUserData(),a.BodyB=s.id,setTimeout(function(){t.members.parent.trigger("on_collision",a)},0)},o.prototype.setContactlistner=function(){var e,t,s;s=this,e=new this.BOX2D.b2ContactListener,e.PreSolve=function(e){t=e.GetFixtureA().GetBody().GetUserData(),t.sensor===!0&&e.SetEnabled(!1),t=e.GetFixtureB().GetBody().GetUserData(),t.sensor===!0&&e.SetEnabled(!1)},e.PostSolve=function(){},e.BeginContact=function(e){s.collisionInformer(e),t=e.GetFixtureA().GetBody().GetUserData(),t.absorb===!0&&(t=e.GetFixtureB().GetBody().GetUserData(),void 0!==t&&null!==t&&(t.kill=!0)),t=e.GetFixtureB().GetBody().GetUserData(),t.absorb===!0&&(t=e.GetFixtureA().GetBody().GetUserData(),void 0!==t&&null!==t&&(t.kill=!0))},e.EndContact=function(e){t=e.GetFixtureA().GetBody().GetUserData(),"dynamic"===t.id.type&&t.collideOnce===!0&&(t.sensor=!0),t=e.GetFixtureB().GetBody().GetUserData(),"dynamic"===t.id.type&&t.collideOnce===!0&&(t.sensor=!0)},this.members.b2World.SetContactListener(e)},o.prototype.applyOnAll=function(e){var t,s,i,o,r;for(t=e.name,s=e.val,i=this.members.b2World.m_bodyList;null!==i&&void 0!==i;){if(o=i.m_userData,null===o&&(r=i.m_next,this.members.b2World.DestroyBody(i),i=r,null===i))return void 0;switch(t){case 1:this.updateSpeed(i,s)}i=i.m_next}},o.prototype.setBodyPosition=function(e,t){var s,i;s=this.getBody(e),void 0!==s&&(void 0!==t.x&&(i=new this.BOX2D.b2Vec2(t.x/this.members.scale,s.GetPosition().y)),void 0!==t.y&&(i=new this.BOX2D.b2Vec2(s.GetPosition().x,t.y/this.members.scale)),s.SetPosition(i))},o.prototype.getBodyType=function(e){var t,s;return t=this.getBody(e),void 0!==t?(s=t.GetUserData(),s.type):void 0},o.prototype.getBodyPosition=function(e){var t;return t=this.getBody(e),void 0!==t?{x:t.m_xf.position.x*this.members.scale,y:t.m_xf.position.y*this.members.scale}:void 0},o.prototype.removeBody=function(e){var t;t=this.getBody(e),void 0!==t&&(t.m_userData.kill=!0)},o.prototype.getBody=function(e){var t,s,i,o;for(t=this.members.b2World.m_bodyList;null!==t&&void 0!==t;){if(s=t.m_userData,null===s&&(i=t.m_next,this.members.b2World.DestroyBody(t),t=i,null===t))return void 0;if(s.id.indexOf(e)>=0&&(o=t),void 0!==o)return o=void 0,t;t=t.m_next}},o.prototype.removeFromWorld=function(e){var t,s,i,o,r,a;if(r=e.m_userData,a=!1,r.killOnOut===!0&&(i=Math.round(e.GetPosition().x*this.members.scale),o=Math.round(e.GetPosition().y*this.members.scale),i>this.members.maxX||0>i?a=!0:(o>this.members.maxY||0>o)&&(a=!0)),r.sleepKill===!0&&e.IsAwake()===!1&&(a=!0),r.kill===!0&&(a=!0),a===!0&&(t=this.members.bodies[r.id],void 0!==t)){var n={};n.exitPoint={x:Math.round(e.GetPosition().x*this.members.scale),y:Math.round(e.GetPosition().y*this.members.scale)},n.type=e.GetType(),this.members.parent.trigger("on_destroy",n),s=t.getView(),s.removeEventListener("tick"),this.members.stage.removeChild(s),t.destroy(),this.members.bodies[r.id]=void 0,a=void 0}},o.prototype.updateSpeed=function(e,t){var s,i;s=e.m_userData,i=e.GetLinearVelocity(),void 0===t&&(t=0),void 0!==s.speed?(s.speed.x=i.x<0?-1*(Math.abs(s.speed.x)+t<=0?0:Math.abs(s.speed.x)+t):Math.abs(s.speed.x)+t<=0?0:Math.abs(s.speed.x)+t,s.speed.y=i.y<0?-1*(Math.abs(s.speed.y)+t<=0?0:Math.abs(s.speed.y)+t):Math.abs(s.speed.y)+t<=0?0:Math.abs(s.speed.y)+t,e.SetLinearVelocity(s.speed)):(i.x<0?i.x=-1*(Math.abs(i.x)+t<=0?0:Math.abs(i.x)+t):i.x>0&&(i.x=Math.abs(i.x)+t<=0?0:Math.abs(i.x)+t),i.y<0?i.y=-1*(Math.abs(i.y)+t<=0?0:Math.abs(i.y)+t):i.y>0&&(i.y=Math.abs(i.y)+t<=0?0:Math.abs(i.y)+t))},o.prototype.doInCurrentStep=function(){var e,t,s;for(e=this.members.b2World.m_bodyList;null!==e&&void 0!==e;){if(t=e.m_userData,null===t&&(s=e.m_next,this.members.b2World.DestroyBody(e),e=s,null===e))return;this.removeFromWorld(e),this.updateSpeed(e),e=e.m_next}},o.prototype.update=function(){this.members.stage.update(),this.members.b2World.Step(1/this.members.fps,10,10),this.members.b2World.ClearForces(),this.doInCurrentStep()},o.prototype.destroy=function(){var e;for(createjs.Ticker.removeEventListener("tick",this.members.tickListener),e=this.members.b2World.m_bodyList;null!==e&&void 0!==e;)this.removeFromWorld(e),e=e.m_next;this.members.dynaCount=0,this.members.staCount=0,this.members.stage=void 0,this.members.bodies=void 0,this.members=void 0},o});