define(["marionette","player/base/base-media-player","components/audioplayer/source/js/audio-player-model"],function(e,t,i){var s=t.extend({template:_.template(""),initialize:function(e){this.members={tag:void 0,ui_play:void 0,ui_pause:void 0,ui_stop:void 0,ui_seekBar:void 0,ui_display:void 0,ui_volume:void 0,ui_volumeBar:void 0,objSeekBar:void 0,objVolumeBar:void 0,constants:void 0,totalDuration:0,currentTime:0,isPlaying:!1,isPaused:!1,currentVolume:1,isVolumeChanging:!1,endTime:void 0,bready:!1},this.members.tag=null,this.model=new i,void 0!==e&&(void 0!==e.loop&&this.model.set("loop",e.loop),void 0!==e.source&&this.model.set("data",e.source),void 0!==e.ui&&(this.model.set("withUi",e.ui),void 0!==e.context&&(this.members.base_activity=e.context)),this.storeCuePoints(e),this.members.tag=document.createElement("audio"),this.setSource(this.model.get("data")),this.applyAudioEvents()),this.initBaseMediaPlayer(this,this.PlayerConstants.AUDIO_MEDIA_PLAYER)},storeCuePoints:function(e){e.hasOwnProperty("cuePoints")&&e.cuePoints.length>0&&(this.hasCuePoints=!0,this.cuePoints=e.cuePoints.slice(0,e.cuePoints.length),this.orgCuePoints=_.extend({},e.cuePoints),this.cuePoints.sort(function(e,t){return e-t})),e.hasOwnProperty("eventPrefix")&&void 0!==e.eventPrefix&&(this.eventPrefix=e.eventPrefix)},setSource:function(e){var t,i;if(i=this.members.tag,e instanceof Array){for(t=0;t<e.length;t+=1)if("mp3"===e[t].type){if(i.canPlayType("audio/mpeg;")){i.setAttribute("src",e[t].path);break}}else if("ogg"===e[t].type&&i.canPlayType("audio/ogg;")){i.setAttribute("src",e[t].path);break}}else i.setAttribute("src",e)},applyAudioEvents:function(){var e,t,i;t=this,e=t.members,i=e.tag,void 0!==i&&(i.loadStart=function(){this.addEventListener("canplay",i.canPlay),this.addEventListener("loadedmetadata",i.metaLoaded)},i.metaLoaded=function(){this.removeEventListener("loadedmetadata",i.metaLoaded),e.totalDuration=this.duration,e.currentTime=0,t.updatePlayerUIValues()},i.canPlay=function(){this.removeEventListener("canplay",i.canPlay),this.volume=e.currentVolume,t.customEventDispatcher("readyToPlay",t,this.duration),e.bready&&(e.bready=!1,t.play())},i.timeUpdate=function(){t.customEventDispatcher(t.AUDIO_PROGRESS_EVENT,t,this.currentTime),t.hasCuePoints&&t.cuePointEventDispatcher(t,this.currentTime),e.currentTime=this.currentTime,t.updatePlayerUIValues(),e.endTime&&e.endTime<=e.currentTime&&(t.customEventDispatcher(t.AUDIO_FINISH_EVENT,t,this.currentTime),t.pause())},i.audioEnded=function(){return t.customEventDispatcher(t.AUDIO_FINISH_EVENT,t,this.currentTime),this.currentTime=0,e.currentTime=0,t.model.get("loop")?(this.volume=e.currentVolume,t.play(),void 0):(t.stop(),void 0)},i.addEventListener("loadstart",i.loadStart),i.addEventListener("ended",i.audioEnded),i.addEventListener("timeupdate",i.timeUpdate))},onShow:function(){this.model.get("withUi")&&this.showUi()},onPlayerResizeEvent:function(){var e,t;e=this,t=this.members,t.objSeekBar&&t.objSeekBar.setStageScaleValue(this.getStageScaleValue()),t.objVolumeBar&&t.objVolumeBar.setStageScaleValue(this.getStageScaleValue())},showUi:function(){var e,t;e=this,t=this.members,t.ui_play=$("<div class='play'></div>"),t.ui_pause=$("<div class='pause'></div>"),t.ui_stop=$("<div class='stop'></div>"),t.ui_display=$("<div class='display'></div>"),t.ui_volume=$("<div class='volume'></div>"),require(["css!components/audioplayer/source/css/audio-player.css","components/slider/slider","components/slider/js/sliderconst"],function(i,s,a){t.constants=a,e.createSliders(s,a)})},createSliders:function(e,t){var i,s,a,o;s=this,a=this.members,i={},o=$("<div class='seekbarSlider' style='visibility:hidden;'></div>"),this.$el.append(o),i.sliderLength=parseFloat(o.css("width")),0===i.sliderLength&&(i.sliderLength=100),o.remove(),i.allignment=t.CONSTANTS.HORIZONTAL,i.sliderWrapperStyle="seekbarSlider",a.objSeekBar=new e(i),a.objSeekBar.render(),a.ui_seekBar=a.objSeekBar.$el,i={},o=$("<div class='volumebarSlider' style='visibility:hidden;'></div>"),this.$el.append(o),i.sliderLength=parseFloat(o.css("height")),0===i.sliderLength&&(i.sliderLength=100),o.remove(),i.allignment=t.CONSTANTS.VERTICAL,i.sliderWrapperStyle="volumebarSlider",a.objVolumeBar=new e(i),a.objVolumeBar.render(),a.ui_volumeBar=a.objVolumeBar.$el,this.$el.append(a.ui_play),this.$el.append(a.ui_pause),this.$el.append(a.ui_stop),this.$el.append(a.ui_seekBar),this.$el.append(a.ui_display),this.$el.append(a.ui_volume),a.ui_volume.append(a.ui_volumeBar),a.objSeekBar.configureView(a.objSeekBar),a.objVolumeBar.configureView(a.objVolumeBar),a.objSeekBar.setStageScaleValue(this.getStageScaleValue()),a.objVolumeBar.setStageScaleValue(this.getStageScaleValue()),s.decorateUi()},decorateUi:function(){var e;e=this.members,e.ui_volumeBar.css("width","100%"),e.ui_volumeBar.css("height","100%"),e.ui_seekBar.css("width","100%"),e.ui_seekBar.css("height","100%"),e.ui_volumeBar.hide(),this.applyUiEvents(),this.updatePlayerUIValues()},applyUiEvents:function(){var e,t;e=this.members,t=this,e.objSeekBar.on(e.constants.EVENTS.SLIDING_STARTED,function(){e.tag.pause()}),e.objSeekBar.on(e.constants.EVENTS.SLIDING_IN_PROGRESS,function(){}),e.objSeekBar.on(e.constants.EVENTS.SLIDING_STOPPED,function(i){e.tag.currentTime=i*e.totalDuration/100,t.members.isPlaying&&e.tag.play()}),e.objVolumeBar.on(e.constants.EVENTS.SLIDING_STARTED,function(t){e.isVolumeChanging=!0,e.tag.volume=t/100,e.currentVolume=t/100}),e.objVolumeBar.on(e.constants.EVENTS.SLIDING_IN_PROGRESS,function(t){e.isVolumeChanging=!0,e.tag.volume=t/100,e.currentVolume=t/100}),e.objVolumeBar.on(e.constants.EVENTS.SLIDING_STOPPED,function(t){e.isVolumeChanging=!1,e.tag.volume=t/100,e.currentVolume=t/100}),e.ui_play.on("click",this.uiPlay.bind(this)),e.ui_pause.on("click",this.uiPause.bind(this)),e.ui_stop.on("click",this.uiStop.bind(this)),e.ui_volume.on("click",function(){e.ui_volumeBar.toggle()}),e.ui_volume.on("mouseover",function(){e.ui_volumeBar.show()}),e.ui_volume.on("mouseout",function(){e.ui_volumeBar.hide()})},uiPlay:function(){this.play()},uiPause:function(){this.pause()},uiStop:function(){this.stop()},updatePlayerUIValues:function(){var e,t;e=this.members,e.objVolumeBar&&!e.isVolumeChanging&&e.objVolumeBar.setCurrentPosition(100*e.currentVolume),e.objSeekBar&&e.objSeekBar.setCurrentPosition(e.currentTime/e.totalDuration*100),e.ui_display&&e.ui_display.length&&(t=e.currentTime.toFixed(2).toString(),t.length<5&&(t="0"+t),e.ui_display.text(t)),e.ui_play&&(e.isPlaying?e.ui_play.addClass("active"):e.ui_play.removeClass("active")),e.ui_pause&&(e.isPaused?e.ui_pause.addClass("active"):e.ui_pause.removeClass("active"))}});return s.prototype.__super__=t,_.extend(s.prototype,{AUDIO_START_EVENT:"audiostart",AUDIO_PAUSE_EVENT:"audiopause",AUDIO_PROGRESS_EVENT:"audioprogress",AUDIO_STOP_EVENT:"audiostop",AUDIO_FINISH_EVENT:"audiofinish",changeAudio:function(e){this.model.set("data",e.source),this.model.set("loop",e.loop),this.stop(),this.members.bready=!1,e.playOnReady===!0&&(this.members.bready=!0),this.setSource(this.model.get("data")),this.storeCuePoints(e)},playAudio:function(){this.play()},play:function(e,t){this.members.bready=!1,this.members.endTime=void 0,e&&(this.setCurrentTime(e),t&&t>e&&(this.members.endTime=t)),this.members.isPlaying=!0,this.members.isPaused=!1,this.members.tag.play(),this.customEventDispatcher(this.AUDIO_START_EVENT,this)},resume:function(){this.play()},pause:function(){this.members.isPlaying&&(this.members.isPlaying=!1,this.members.isPaused=!0,this.members.tag.pause(),this.customEventDispatcher(this.AUDIO_PAUSE_EVENT,this))},stop:function(){if(this.members.isPlaying){this.members.isPlaying=!1,this.members.isPaused=!1;try{this.members.tag.pause(),this.members.tag.currentTime=0}catch(e){}this.customEventDispatcher(this.AUDIO_STOP_EVENT,this)}},setCurrentTime:function(e){this.members.tag.currentTime=e,this.members.currentTime=e},getCurrentTime:function(){return this.members.tag.currentTime},setVolume:function(e){this.members.tag.volume=e,this.members.currentVolume=e},getVolume:function(){return this.members.tag.volume},destroy:function(){this.unregisterMedia();var e=this.members;return this.stop(),e.tag.removeEventListener("loadstart",e.tag.loadStart),e.tag.removeEventListener("ended",e.tag.audioEnded),e.tag.removeEventListener("timeupdate",e.tag.timeUpdate),e.tag.removeAttribute("src"),this.model.get("withUi")&&(e.ui_play.off("click"),e.ui_pause.off("click"),e.ui_stop.off("click"),e.ui_volume.off("click"),e.objSeekBar.off(e.constants.EVENTS.SLIDING_STARTED),e.objSeekBar.off(e.constants.EVENTS.SLIDING_IN_PROGRESS),e.objSeekBar.off(e.constants.EVENTS.SLIDING_STOPPED),e.objSeekBar.destroy(),e.objVolumeBar.off(e.constants.EVENTS.SLIDING_STARTED),e.objVolumeBar.off(e.constants.EVENTS.SLIDING_IN_PROGRESS),e.objVolumeBar.off(e.constants.EVENTS.SLIDING_STOPPED),e.objVolumeBar.destroy()),this.model.destroy(),e.tag=null,this.__super__.prototype.destroy(!0)}}),s});