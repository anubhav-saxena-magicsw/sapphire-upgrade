define(["marionette","underscore","jqueryUI","jqueryTouchPunch","player/base/base-composite-comp","text!player/components/ommeter/om-meter.html"],function(t,e,o,n,i,s){var r;return r=i.extend({template:e.template(s),KNOB_BUTTON_STATE_CHANGE:"knob_position_change_event",SWITCH_BUTTON_CLICK_EVENT:"switchButtonChangeEvent",knob:void 0,connectionPoint:[],rotationDegree:[],knobIndex:0,OFF:"KNOB_OFF",ON:"KNOB_ON",ERROR:"ERROR",strMeterMode:void 0,display:void 0,meterValue:void 0,connectionPointLen:4,numOfKnobPosition:8,knobCurrentPosition:0,divMeterKnob:void 0,bgDimension:760,bReverseMode:!0,dataObject:void 0,arrConnerctor:[],connectionObject:[],arrSwitchButtons:[],arrSwitchAngles:[],isRunningOnDevice:!1,objKnobBase:null,objKnob:null,objKnobOffset:null,objKnobBaseOffset:null,objKnobContainer:null,nCurrentNeedleAngle:0,nCurrentAngle:0,bKnobOffSetCalculated:!1,bKnobBaseOffSetCalculated:!1,bIsActive:!0,onRender:function(){this.bgDimension=this.dataObject.bgDimension,this.bReverseMode=void 0!==this.dataObject.reverseMode?this.dataObject.reverseMode:!0,this.numOfKnobPosition=Number(this.dataObject.numberOfSteps),this.arrState=this.dataObject.meterState,this.bCreateSwitchButtons=this.dataObject.createSwitch,this.arrSwitchAngles=this.dataObject.switchAngles,this.createMeterElements()},initialize:function(t){this.arrSwitchButtons=[],this.arrSwitchAngles=[],this.arrConnector=[],this.connectionObject=[],this.isRunningOnDevice=device.mobile()||device.tablet()?!0:!1,this.dataObject=t,this.degree=0,this.first=void 0},findNearestAngle:function(t){var e,o,n,i,s,r,h=null;return n=this.arrSwitchAngles,o=this.arrSwitchAngles.length,i=this.arrSwitchAngles[o-1],t>i?(s=this.arrSwitchAngles[0],r=i-s,h=t<=Number(r/2)+Number(i)?i:s):$.each(this.arrSwitchAngles,function(){(null===h||Math.abs(this-t)<Math.abs(h-t))&&(h=this)}),e=Number(h)},onShow:function(){this.objKnobBase=$(this.el).find("#meterKnobBase"),this.objKnob=$(this.el).find("#meterKnob"),this.elCenterDiv=$(this.el).find("#centerDiv"),this.elCenterDiv.css("left",parseFloat(this.objKnob.css("left"))+this.objKnob.width()/2-5+"px"),this.elCenterDiv.css("top",parseFloat(this.objKnob.css("top"))+this.objKnob.height()/2-5+"px"),this.addEvents()},addEvents:function(){this.isRunningOnDevice?this.objKnob.off("touchstart").on("touchstart",$.proxy(this.downOnKnob,this)):this.objKnob.off("mousedown").on("mousedown",$.proxy(this.downOnKnob,this))},clickOnKnobBase:function(t){this.bIsActive&&(this.bKnobBaseOffSetCalculated||(this.bKnobBaseOffSetCalculated=!0,this.objKnobBaseOffset=this.objKnobBase.offset()),this.rotateKnob(t))},downOnKnob:function(){this.bIsActive&&(this.objKnobOffset=this.objKnob.offset(),this.isRunningOnDevice?(this.objKnob.off("touchmove").on("touchmove",$.proxy(this.moveOnKnob,this)),this.objKnob.off("touchend").on("touchend",$.proxy(this.upOnKnob,this)),this.objKnob.off("mouseout").on("mouseout",$.proxy(this.upOnKnob,this))):(this.objKnob.off("mousemove",$.proxy(this.moveOnKnob,this)).on("mousemove",$.proxy(this.moveOnKnob,this)),this.objKnob.off("mouseup",$.proxy(this.upOnKnob,this)).on("mouseup",$.proxy(this.upOnKnob,this)),this.objKnob.off("mouseout").on("mouseout",$.proxy(this.upOnKnob,this))))},moveOnKnob:function(t){this.rotateKnob(t)},upOnKnob:function(){var t,e={};this.first=void 0,t=this.findNearestAngle(this.degree),this.degree=t,this.setKnobAngle(t),this.isRunningOnDevice?(this.objKnob.off("touchmove",$.proxy(this.moveOnKnob,this)),this.objKnob.off("touchend",$.proxy(this.upOnKnob,this))):(this.objKnob.off("mousemove",$.proxy(this.moveOnKnob,this)),this.objKnob.off("mouseup",$.proxy(this.upOnKnob,this)),this.objKnob.off("mouseout",$.proxy(this.upOnKnob,this))),e.type=this.KNOB_BUTTON_STATE_CHANGE,e.currentIndex=this.getCurrentKnobPosition(),this.trigger(this.KNOB_BUTTON_STATE_CHANGE,e)},setKnobAngle:function(t){this.objKnob.css("-moz-transform","rotate("+t+"deg)"),this.objKnob.css("-webkit-transform","rotate("+t+"deg)"),this.objKnob.css("-o-transform","rotate("+t+"deg)"),this.objKnob.css("-ms-transform","rotate("+t+"deg)")},getAngleForKnob:function(t){var e,o,n,i,s,r;this.isRunningOnDevice?(t.preventDefault(),r=t.originalEvent.touches[0]):r=t,e=this.elCenterDiv.offset().left+this.elCenterDiv.width()*this.getStageScaleValue()/2,o=this.elCenterDiv.offset().top+this.elCenterDiv.height()*this.getStageScaleValue()/2,n=r.pageX,i=r.pageY,s=Math.atan2(n-e,i-o),this.degree=parseFloat(this.degree),this.first&&(this.degree+=s*(180/Math.PI)*-1<0?360+s*(180/Math.PI)*-1-this.first:s*(180/Math.PI)*-1-this.first),this.first=s*(180/Math.PI)*-1<0?360+s*(180/Math.PI)*-1:s*(180/Math.PI)*-1,this.degree<0&&(this.degree=360-Math.abs(this.degree)),this.degree>360&&(this.degree=this.degree%360)},rotateKnob:function(t){var e;e=t.target.id,this.getAngleForKnob(t),this.setKnobAngle(this.degree)},getCurrentKnobPosition:function(){var t,e,o;for(e=this.arrSwitchAngles.length,t=0;e>t;t++)if(this.degree==this.arrSwitchAngles[t]){o=t;break}return this.arrState[o]}}),r.prototype.mode=function(t){this.strMeterMode=t},r.prototype.__super__=i,r.prototype.setKnobPosition=function(){},r.prototype.createMeterElements=function(){var t,e,o,n,i=this;for(t=$('<div id="meterHolder"/>'),e=$('<div id="" type="connectionPoint" index="" style="width:10px;height:10px;background:yellow"/>'),o=1;o<=this.connectionPointLen;o+=1)e=$('<div id="point_'+o+'" type="connectionPoint" index="" class="point'+o+'"/>'),t.append(e),this.arrConnerctor.push($(e).attr("id"));if(this.$el.find("[id=bgHolder]").append(t),this.bCreateSwitchButtons===!0)for(o=0;o<this.numOfKnobPosition;o+=1)n=$('<div id="switch'+o+'" class="switchStyle'+o+'" indexValue="'+o+'"/>'),t.append(n),this.arrSwitchButtons.push(n),n.on(this.getEventType(),i,i.handleSwitchClick);this.initlizeButtons()},r.prototype.handleSwitchClick=function(t){var e,o=Number($(t.currentTarget).attr("indexValue"));t.data.degree=t.data.arrSwitchAngles[o],t.data.setKnobAngle(t.data.degree),e={},e.type=t.data.SWITCH_BUTTON_CLICK_EVENT,e.currentIndex=o,t.data.trigger(e.type,e)},r.prototype.getDiv=function(t){return $("<div id='"+t.startDiv+"' class='"+t.startCss+"'/><div id='"+t.endDiv+"' class='"+t.endCss+"'/>")},r.prototype.initlizeButtons=function(){},r.prototype.handleKnobClick=function(t){t.data.setKnobPosition()},r.prototype.setKnobPosition=function(t){var e,o;this.bReverseMode===!0?(void 0===t&&(this.knobCurrentPosition=this.knobCurrentPosition+1),this.knobCurrentPosition=this.knobCurrentPosition<this.numOfKnobPosition?this.knobCurrentPosition:0,e=this.bgDimension/this.numOfKnobPosition*this.knobCurrentPosition,e=this.bReverseMode===!0?this.bgDimension-e:e):(void 0===t&&(this.knobCurrentPosition=this.knobCurrentPosition-1),e=this.bgDimension/this.numOfKnobPosition*this.knobCurrentPosition,e=this.bgDimension-e),this.divMeterKnob.css("background-position",e+"px 0px"),o={},o.type=this.KNOB_BUTTON_STATE_CHANGE,o.currentIndex=this.knobCurrentPosition,this.trigger(this.KNOB_BUTTON_STATE_CHANGE,o)},r.prototype.getEventType=function(){var t="mousedown";return t},r.prototype.changeDisplayStyle=function(){var t=this.$el.find("[id=displayText]");t.removeClass(),t.addClass("displayText")},r.prototype.setText=function(t){var e=this.$el.find("[id=displayText]");e.html(t)},r.prototype.enable=function(t){var e=this;t===!0?(this.divMeterKnob.off(this.getEventType()),this.divMeterKnob.on(this.getEventType(),e,e.handleKnobClick)):this.divMeterKnob.off(this.getEventType())},r.prototype.getMeterState=function(){return this.getCurrentKnobPosition()},r.prototype.reset=function(){this.degree=0,this.setKnobAngle(0)},r.prototype.getConnectorList=function(){return this.arrConnerctor},r.prototype.destroy=function(){var t=0;for(t=0;t<this.arrSwitchButtons.length;t+=1)this.arrSwitchButtons[t].off(this.getEventType());return this.arrConnerctor=[],this.divMeterKnob.off(this.getEventType()),this.__super__.prototype.destroy(!0)},r});