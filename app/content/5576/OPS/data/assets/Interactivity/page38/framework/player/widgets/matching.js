!function(t){t.widget("custom.MATCHING",t.custom.BASEWIDGET,{options:{correctMapping:[],shuffle:!1,linkType:"line",previousSource:null,isOneToOne:!0,$svgElem:t("<svg xmlns='http://www.w3.org/2000/svg' style='width:100%; height:100%;position:absolute;'></svg>"),functionList:["checkAnswer","showAnswer","reset","disable"]},_create:function(){void 0===this.options.widgetData.feedbackType&&(this.options.widgetData.feedbackType=1),t(this.element).prepend(this.options.$svgElem)},_init:function(){this.options.widgetData.feedbackType||(this.options.widgetData.feedbackType=1),this.attachListeners("[type=target]"),this.attachListeners("[type=source]")},attachListeners:function(e){var e,i,s=this;t.each(t(this.element).find(e),function(){var e;t(this).off("click").on("click",function(t){s.onItemClicked(t)}),t(this).attr("ans")&&(e=t(this).attr("id")+":"+t(this).attr("ans"),t(this).removeAttr("ans"),s.options.correctMapping.push(e),1===s.options.widgetData.feedbackType&&(i=t("<div></div>"),i.prop("correct",t("<div class='"+s.options.widgetData.styleCorrect+"'></div>")),i.append(i.prop("correct")),i.prop("incorrect",t("<div class='"+s.options.widgetData.styleIncorrect+"'></div>")),i.append(i.prop("incorrect")),t(this).prop("feedback",i),t(this).attr("style-feedback")?i.addClass(t(this).attr("style-feedback")):i.css({left:parseFloat(t(this).css("left"))+t(this).outerWidth()+"px",top:t(this).css("top"),position:"absolute"})))})},removeListeners:function(e){t(this.element).find(e).off("click")},onItemClicked:function(e){var i,s=this;t(e.currentTarget).hasClass("disabled")||(i=t(e.currentTarget).attr("type"),"source"===i?s.saveSourceRefernece(s,e.currentTarget):(s.isTargetOccupied(e.currentTarget)&&s.isSourceSelected()&&s.removeLink(e.currentTarget),s.isSourceSelected()&&(s.options.isOneToOne&&s.removeLink(s.options.previousSource),s.addDataToSourceAndTarget(s.options.previousSource,e.currentTarget),s.drawLink(s.options.previousSource,e.currentTarget)),s.removeActiveState(s.options.previousSource)),this.dispatchEvent("ON_ITEM_CLICKED",this,t(e.currentTarget)),this.options.correctMapping.length===this.getLinkedObjectsMap().length?this.dispatchEvent("ALL_SET",this,!0):this.dispatchEvent("ALL_SET",this,!1))},addDataToSourceAndTarget:function(e,i){var s,r,o;t(i).attr("source",t(e).attr("id")),r=t(i).attr("id"),this.options.OneToOne?t(e).attr("target",r):(s=t(e).attr("target"),s?(s=s+"|"+r,o=s.split("|"),o.sort(),s=o.join("|")):s=r,t(e).attr("target",s))},saveSourceRefernece:function(e,i){e.removeActiveState(e.options.previousSource),e.options.previousSource=t(i),e.applyActiveState(t(i))},isTargetOccupied:function(e){return t(e).attr("source")?!0:!1},isSourceSelected:function(){return t(this.options.previousSource).hasClass("selected")?!0:!1},applyActiveState:function(t){t.addClass("selected")},removeActiveState:function(t){t&&t.removeClass("selected")},drawLink:function(e,i){var s,r,o,a,n,c,p,d,l,h;s=parseInt(t(e).css("left"),10),r=parseInt(t(e).css("top"),10),o=s+t(e).outerWidth(),a=r+t(e).outerHeight()/2,n=parseInt(t(i).css("left"),10),c=parseInt(t(i).css("top"),10),p=n,d=c+t(i).outerHeight()/2,l=t(e).attr("id")+"_"+t(i).attr("id"),h=document.createElementNS("http://www.w3.org/2000/svg","line"),h.setAttribute("id",l),h.setAttribute("x1",o),h.setAttribute("y1",a),h.setAttribute("x2",p),h.setAttribute("y2",d),this.options.$svgElem.append(h)},removeLink:function(e){var i,s,r,o,a,n,c;i=t(e).attr("type"),"target"===i?(s=t(e).attr("source"),o=s+"_"+t(e).attr("id"),t("#"+o).remove(),t(e).attr("source",null),this.options.isOneToOne?t("#"+s).attr("target",null):(a=t("#"+s).attr("target"),n=a.split("|"),c=n.indexOf(t(e).attr("id")),n.splice(c,1),n.sort(),a=n.join("|"),t("#"+s).attr("target",a))):(r=t(e).attr("target"),o=t(e).attr("id")+"_"+r,t("#"+o).remove(),t("#"+r).attr("source",null),t(e).attr("target",null))},checkAnswer:function(t){var e,i,s,r,o,a;for(console.log(t),t instanceof Array&&(t=t[0]),t&&this.disable(!0,t),e=this.options.correctMapping,i=e.length,s=this.getLinkedObjectsMap(),r=0,o=0;i>o;o++){var n=e[o].split(":")[0];e.indexOf(s[o])>-1?(this._showCorrectFeedback(n),r++):this._showIncorrectFeedback(n)}a={},a.correctAnswer=r,a.totalQuestion=s.length,this.dispatchEvent("ON_CHECK_ANSWER",this,a)},showAnswer:function(e){var i,s,r,o,a,n,c,p,d,l;for(i=this.options.correctMapping,s=i.length,e instanceof Array&&(e=e[0]),e&&this.disable(!0,e),r=0;s>r;r++){if(a=i[r],n=a.split(":")[0],c=a.split(":")[1],p=t("#"+n),c.indexOf("|")>-1)for(l=c.split("|"),o=0;o<l.length;o++)d=t("#"+l[o]),d.attr("source",n);else d=t("#"+c),d.attr("source",n);p.attr("target",c),this.removeActiveState(p)}this._redrawSvg(),this.dispatchEvent("ON_SHOW_ANSWER")},reset:function(e){var i,s,r,o,a,n,c,p,d,l,h;for(e instanceof Array&&(e=e[0]),(void 0===e||0===e.length)&&(e="ALL"),this.disable(!1,e),s=this.options.correctMapping,o=this.getLinkedObjectsMap(),r=o.length,a=0;r>a;a++){if(i=!1,c=o[a],p=c.split(":")[0],l=t("#"+p),d=c.split(":")[1],s.indexOf(o[a])>-1?("ALL"===e||"CORRECT"===e)&&(i=!0):("ALL"===e||"INCORRECT"===e)&&(i=!0),i)if(l.attr("target",null),this._resetFeedback(p),d.indexOf("|")>-1)for(h=d.split("|"),n=0;n<h.length;n++)t("#"+h[n]).attr("source",null);else t("#"+d).attr("source",null);this.removeActiveState(l)}this._redrawSvg(),this.dispatchEvent("ON_RESET")},_redrawSvg:function(){var e,i,s,r,o,a,n,c;for(this.options.$svgElem.empty(),e=this.getLinkedObjectsMap(),i=0;i<e.length;i+=1)if(r=e[i],o=r.split(":")[0],a=r.split(":")[1],n=t("#"+o),a.indexOf("|")>-1)for(c=a.split("|"),s=0;s<c.length;s++)this.drawLink(n,t("#"+c[s]));else this.drawLink(n,t("#"+a))},disable:function(e,i){var s,r,o,a;for(e instanceof Array&&(i=e[1],e=e[0]),(void 0===i||0===i.length)&&(i="ALL"),e="true"==e||e===!0?!0:!1,r=this.options.correctMapping,o=r.length,a=this.getLinkedObjectsMap(),s=0;o>s;s++){var n,c,p;p=r[s].split(":")[0],n=t(this.element).find("#"+p),p=r[s].split(":")[1],c=t(this.element).find("#"+p),r.indexOf(a[s])>-1?("ALL"===i||"CORRECT"===i)&&(e?(n.addClass("disabled"),c.addClass("disabled")):(n.removeClass("disabled"),c.removeClass("disabled"))):("ALL"===i||"CORRECT"===i)&&(e?(n.addClass("disabled"),c.addClass("disabled")):(n.removeClass("disabled"),c.removeClass("disabled")))}},getLinkedObjectsMap:function(){var e,i,s,r,o,a;for(e=t(this.element).find("[type=source]"),i=e.length,o=[],r=0;i>r;r++)s=e[r],a=t(s).attr("id")+":",t(s).attr("target")&&(a+=t(s).attr("target"),o.push(a));return o},_showCorrectFeedback:function(e){var i=t(this.element).find("#"+e);1===this.options.widgetData.feedbackType&&(t(i).prop("feedback").prop("correct").show(),t(i).prop("feedback").prop("incorrect").hide(),t(this.element).append(t(i).prop("feedback")))},_showIncorrectFeedback:function(e){var i=t(this.element).find("#"+e);1===this.options.widgetData.feedbackType&&(t(i).prop("feedback").prop("incorrect").show(),t(i).prop("feedback").prop("correct").hide(),t(this.element).append(t(i).prop("feedback")))},_resetFeedback:function(e){var i=t(this.element).find("#"+e);1===this.options.widgetData.feedbackType&&t(i).prop("feedback").remove()},_destroy:function(){this.removeListeners("[type=target]"),this.removeListeners("[type=source]")}})}(jQuery);