define(["marionette","jqueryUI","jqueryTouchPunch","player/base/base-composite-comp","text!components/calculator/template/calculator.html","components/calculator/model/calculator-model","player/components/calculator/js/calculator-item","css!components/calculator/template/style/calculator.css"],function(e,t,s,o,i,l,a){var r=o.extend({template:_.template(i),itemView:a,itemViewContainer:"#calculatorButtonContainer",calculatorWrapper:null,boundingBox:null,click:{},calculatorTextItem:null,activityContainment:null,initialize:function(e){var t,s,o,i,r,d=[],n={};for(this.click={},this.calculatorWrapper={},this.boundingBox={},this.calculatorTextItem={},this.activityContainment={},this.model=new l,this.parseCompData(e,this.model),this.on(a.BUTTON_CLICKED,this.onButtonClicked),$(window).bind("keydown",this,this.handleKeyPress),this.itemViewOptions={context:this},n=this.model.get("buttonCollection"),r=Backbone.Model.extend({defaults:{styleName:"",value:"",type:"",label:""}}),i=Backbone.Collection.extend({model:r}),o=n.length,s=0;o>s;s+=1)t=new r,t.set("type",n[s].type),t.set("styleName",n[s].styleName),t.set("value",n[s].value),t.set("label",n[s].label),d.push(t);this.collection=new i(d),this.model.on("change",$.proxy(this.onModelChange,this)),this.createTextDisplay()},createTextDisplay:function(){var t=e.ItemView.extend({template:"<div> {{ textDisplay }}</div>",initialize:function(e){var t=Backbone.Model.extend({});this.model=new t(e),this.render(),this.model.on("change",this.render,this)},changeData:function(e){this.model.set("textDisplay",e)}});this.calculatorTextItem=new t({textDisplay:this.model.get("textDisplay")})},onRender:function(){this.$("#calculatorWrapper").addClass(this.model.get("calculatorWrapperStyle"))},onShow:function(){var e=this;this.calculatorWrapper=this.$("#calculatorWrapper"),$(this.calculatorWrapper).draggable({containment:"document",scroll:!1,start:$.proxy(this.onDraggingStart,this),drag:$.proxy(this.onDragging,this),stop:$.proxy(this.onDraggingStop,this)}),this.$("#calcInput").html(this.calculatorTextItem.el),this.$el.on("click",$.proxy(e.compClick,e)),this.$el.on("mouseover",$.proxy(e.compRollover,e)),this.$el.on("mouseout",$.proxy(e.compRollout,e))},onModelChange:function(){this.calculatorTextItem.changeData(this.model.get("textDisplay"))},onDraggingStart:function(e){this.click.x=e.clientX,this.click.y=e.clientY},onDragging:function(e,t){var s,o,i;i=t.originalPosition,s=(e.clientX-this.click.x+i.left)/this.getStageScaleValue(),o=(e.clientY-this.click.y+i.top)/this.getStageScaleValue(),t.position.left=s,t.position.top=o},onDraggingStop:function(){},handleKeyPress:function(e){var t,s;t=e.data,e.keyCode>=96&&e.keyCode<=105?(s=e.keyCode-96,t.addDigit(s)):e.keyCode>=48&&e.keyCode<=57?(s=e.keyCode-48,t.addDigit(s)):111===e.keyCode||191===e.keyCode?(s="/",t.doOperator(s)):106===e.keyCode?(s="*",t.doOperator(s)):109===e.keyCode||189===e.keyCode?(s="-",t.doOperator(s)):107===e.keyCode?(s="+",t.doOperator(s)):187===e.keyCode?(s="=",t.doOperator(s)):(110===e.keyCode||190===e.keyCode)&&(s=".",t.model.get("decimal")||(t.addDigit(s),t.model.get("decimal",!0)))},onButtonClicked:function(e){var t,s,o;switch(t=e,s=t.get("value"),o=t.get("type")){case this.DIGIT:this.onDigitButtonClick(s);break;case this.DECIMAL:this.onDecimalButtonClick(s);break;case this.OPERATOR:this.onOperatorButtonClick(s);break;case this.CLEAR_DISPLAY:this.onClearDisplayButtonClick(s);break;case this.BACK_SPACE:this.onBackButtonClick(s)}},parseCompData:function(e,t){e&&(e.parentRef&&(this.activityContainment=e.parentRef),void 0!==e.buttonCollection&&t.set("buttonCollection",this.getButtonCollection(e)),void 0!==e.calculatorWrapperStyle&&t.set("calculatorWrapperStyle",e.calculatorWrapperStyle))},getIndex:function(e){var t,s=this.model.get("buttonCollection");for(t=0;t<s.length;t+=1)if(s[t].value===e)return t;return-1},getButtonCollection:function(e){var t,s,o,i,l,a;if(t=this.model.get("buttonCollection"),s=e.buttonCollection.button)for(o=s.length,i=0;o>i;i+=1)l=s[i].value,a=this.getIndex(l),0>a?t.push(s[i]):(t[a].label=s[i].label,t[a].styleName=s[i].styleName);return t},onDigitButtonClick:function(e){var t=parseInt(e,10);this.addDigit(t)},onOperatorButtonClick:function(e){this.doOperator(e)},onDecimalButtonClick:function(e){this.model.get("decimal")||(this.addDigit(e),this.model.set("decimal",!0))},onClearDisplayButtonClick:function(){this.model.set("textDisplay","0"),this.displayValue()},onResetButtonClick:function(){this.clearBtnClick()},onBackButtonClick:function(){var e,t;e=this.model.get("textDisplay");try{t=String(this.model.get("textDisplay")).length-1,e=String(this.model.get("textDisplay")).substr(0,t),this.model.set("textDisplay",e),this.model.set("operand1",e)}catch(s){}(""===e||void 0===t)&&(this.model.set("textDisplay","0"),this.model.set("operand1","0")),console.log("onBackButtonClick:"+this.model.get("textDisplay")+"::"+this.model.get("operand1")),this.model.set("isEqualPressed",!1),this.displayValue()},clearBtnClick:function(){this.onClearButtonClick()},onClearButtonClick:function(){this.model.set("operand1",!1),this.model.set("textDisplay","0"),this.model.set("operator",""),this.model.set("clear",!1),this.model.set("decimal",!1),this.model.set("Status",""),this.model.set("setflag",!1),this.model.set("display_flag","0"),this.model.set("flag_inv","0"),this.displayValue(),this.model.set("isNumberPressed",!1),this.model.set("previousOperator","undefined"),this.model.set("previousNumber","undefined"),this.model.set("isEqualPressed",!1),this.model.set("canCalculate","undefined"),this.model.set("previousInput","undefined")},doOperator:function(e){var t=!1;this.model.get("error")||("="===e?this.model.set("previousInput",e):"squareRoot"===e||"cubeRoot"===e?(this.model.set("previousInput",e),this.model.set("operator",e),this.doCalculation(this.model.get("previousOperator")),this.model.set("isEqualPressed",!0),this.model.set("previousNumber",this.model.get("textDisplay")),this.model.set("operand1",this.model.get("textDisplay")),this.displayValue(),this.model.set("isEqualPressed",!1),t=!0):"number"!==this.model.get("previousInput")&&"="!==this.model.get("previousInput")?(this.model.set("previousInput",e),this.model.set("operator",e),t=!0):this.model.set("previousInput",e),t||(this.model.get("isNumberPressed")===!1&&"="!==e?(this.model.set("isEqualPressed",!1),this.model.set("previousOperator",e),this.model.set("operator",e),t=!0):"="!==e&&this.model.set("previousInput",e),t||("="!==e?(this.doCalculation(e),this.model.set("isEqualPressed",!1)):(this.model.get("isNumberPressed")?this.model.set("previousNumber",Number(this.model.get("operand1"))):this.model.set("operand1",this.model.get("previousNumber")),this.doCalculation(this.model.get("previousOperator")),this.model.set("isEqualPressed",!0)),this.displayValue())))},doCalculation:function(e){"squareRoot"===this.model.get("operator")&&(this.model.set("textDisplay",parseFloat(Number(Math.sqrt(this.model.get("textDisplay"))))),this.model.set("isNumberPressed",!1),this.model.set("bForceRound",!0),this.forceRound()),"cubeRoot"===this.model.get("operator")&&(this.model.set("textDisplay",parseFloat(Number(Math.pow(this.model.get("textDisplay"),1/3)))),this.model.set("isNumberPressed",!1),this.model.set("bForceRound",!0),this.forceRound()),"xRestY"===this.model.get("operator")&&(this.model.get("isNumberPressed")&&this.model.set("previousNumber",Number(this.model.get("textDisplay"))),this.model.set("textDisplay",Math.pow(Number(this.model.get("operand1")),Number(this.model.get("textDisplay")))),this.model.set("isNumberPressed",!1),this.model.set("bForceRound",!0),this.forceRound()),"+"===this.model.get("operator")&&(this.model.get("isNumberPressed")&&this.model.set("previousNumber",Number(this.model.get("textDisplay"))),this.model.set("textDisplay",parseFloat(Number(this.model.get("operand1"))+Number(this.model.get("textDisplay")))),this.model.set("isNumberPressed",!1),this.model.set("bForceRound",!0),this.forceRound()),"-"===this.model.get("operator")&&(this.model.get("isNumberPressed")&&this.model.set("previousNumber",Number(this.model.get("textDisplay"))),this.model.get("isNumberPressed")?this.model.set("textDisplay",parseFloat(Number(this.model.get("operand1"))-Number(this.model.get("textDisplay")))):this.model.set("textDisplay",parseFloat(Number(this.model.get("textDisplay"))-Number(this.model.get("operand1")))),this.model.set("isNumberPressed",!1),this.model.set("bForceRound",!0),this.forceRound()),"*"===this.model.get("operator")&&(this.model.get("isNumberPressed")&&this.model.set("previousNumber",Number(this.model.get("textDisplay"))),this.model.set("textDisplay",parseFloat(Number(this.model.get("operand1"))*Number(this.model.get("textDisplay")))),this.model.set("isNumberPressed",!1),this.model.set("bForceRound",!0),this.forceRound()),"/"===this.model.get("operator")&&("0"===this.model.get("operand1")&&"0"===this.model.get("textDisplay")?this.model.set("error",!0):this.model.get("error")||(this.model.get("isNumberPressed")&&this.model.set("previousNumber",Number(this.model.get("textDisplay"))),this.model.get("isNumberPressed")?this.model.set("textDisplay",parseFloat(Number(this.model.get("operand1")/this.model.get("textDisplay")).toFixed(2))):this.model.get("textDisplay",parseFloat(Number(this.model.get("textDisplay")/this.model.get("operand1")).toFixed(2))),this.model.set("isNumberPressed",!0),this.model.set("bForceRound",!1),this.forceRound())),this.model.set("clear",!0),this.model.set("decimal",!1),this.model.set("display_flag","0"),null!==e&&(this.model.set("operator",e),this.model.set("previousOperator",e),this.model.set("operand1",this.model.get("textDisplay")),this.model.set("canCalculate",!1))},forceRound:function(){},dispflag:function(){var e,t;e=this.model.get("display_flag"),t=this.model.get("maxDisplayCount"),this.model.get("textDisplay").length<t||void 0===this.model.get("textDisplay").length?(this.model.set("display_flag",e+1),this.model.set("dispno",!0)):this.model.set("dispno",!1)},refresh:function(){this.model.set("operator","="),this.model.set("clear",!0),this.model.set("decimal",!1),this.model.set("Status",""),null!==this.model.get("newOper")&&(this.model.set("operator",this.model.get("newOper")),this.model.set("operand1",this.model.get("textDisplay")))},addDigit:function(e){this.model.get("isEqualPressed")&&(this.onClearButtonClick(),this.model.set("isEqualPressed",!1)),this.model.set("previousInput","number"),this.model.set("canCalculate",!0),this.model.get("error")&&(this.refresh(),this.model.set("error",!1)),this.model.get("clear")&&(this.model.set("clear",!1),this.model.set("decimal",!1),this.model.set("textDisplay","0")),this.dispflag(),this.model.get("dispno")&&("0"===this.model.get("textDisplay")&&"."!==e?this.model.set("textDisplay",e):this.model.set("textDisplay",this.model.get("textDisplay")+String(e)),this.model.set("isNumberPressed",!0),this.displayValue())},displayValue:function(){var e=this.model.get("textDisplay");this.bForceRound&&(this.model.set("bForceRound",!1),this.model.set("textDisplay",this.preciseRound(Number(e.substr(0,10)),2)))},preciseRound:function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}});return r.prototype.DIGIT="digit",r.prototype.DECIMAL="decimal",r.prototype.OPERATOR="operator",r.prototype.CLEAR_DISPLAY="clearDisplay",r.prototype.BACK_SPACE="backspace",r.prototype.Super=o,r.prototype.flush=function(){var e;if(this.collection)for(;this.collection.first();)e=this.collection.first(),e.id=null,e.destroy(),e=null;this.model&&(this.model.id=null,this.model.destroy(),this.model=null,this.collection=null)},r.prototype.destroy=function(){return this.$el.off("click"),this.$el.off("mouseover"),this.$el.off("mouseout"),this.off(a.BUTTON_CLICKED,this.onButtonClicked),$(window).unbind("keydown"),this.flush(),this.unbind(),this.undelegateEvents(),this.children.call("destroy"),this.children.call("remove"),this.close(),this.Super.prototype.destroy(!0)},r});