!function(t){t.widget("Template.DND",t.custom.BASEWIDGET,{constants:{DRAG_START:"onDragStart",DRAG:"onDrag",DRAG_STOP:"onDragStop",ON_DROP:"onDrop",WIDGET_EVENT:"WIDGET_EVENT",ON_ANSWER_CHECKED:"onAnswerChecked",RESET_COMPLETE:"onReset",INIT_COMPLETE:"initComplete"},dndData:{objPosition:{},bRevert:!0,targetDiv:void 0,containerDiv:void 0,containment:void 0,zPosition:1},options:{parentDiv:null,parentObject:null,widgetData:null,arrDraggableItem:null,arrDropItem:null,updatedScale:1,currentPos:{},start:{},functionList:["resetDnd","enableOption","disableOption","unfreezeDnd","freezeDnd","checkAnswer"]},_create:function(){},_init:function(){this.initalizeDragItem(),this.initalizeDropItem(),this.dispatchEvent(this.constants.INIT_COMPLETE)},initalizeDragItem:function(){var i,a,o=this;for(this.options.arrDraggableItem=this.options.parentDiv.find("[type=draggable]"),i=0;i<this.options.arrDraggableItem.length;i++)a={},a.id=this.options.arrDraggableItem[i].id,a.left=t(this.options.arrDraggableItem[i]).css("left"),a.top=t(this.options.arrDraggableItem[i]).css("top"),this.dndData.objPosition[a.id]=a;t(o.options.arrDraggableItem).draggable({start:function(t,i){o.onDragStart(t,i)},drag:function(t,i){o.onDrag(t,i)},stop:function(t,i){o.onDragStop(t,i)}}),void 0!==this.options.widgetData.containment&&(this.dndData.containment=t(this.options.widgetData.containment),t(o.options.arrDraggableItem).draggable({containment:o.options.widgetData.containment}))},initalizeDropItem:function(){var a,o=this;for(this.options.arrDropItem=this.options.parentDiv.find("[type=droppable]"),i=0;i<this.options.arrDropItem.length;i++)a={},a.id=this.options.arrDropItem[i].id,a.left=t(this.options.arrDropItem[i]).css("left"),a.top=t(this.options.arrDropItem[i]).css("top"),this.dndData.objPosition[a.id]=a;t(this.options.arrDropItem).droppable({drop:function(t,i){o.onDrop(t,i)}})},onDragStart:function(i,a){var o;this.dndData.zPosition=this.dndData.zPosition+1,a.helper.css("z-index",this.dndData.zPosition),this.dndData.targetDiv=t(a.helper),o=this.dndData.objPosition[this.dndData.targetDiv.attr("id")].dropAt,void 0!==o&&delete this.dndData.objPosition[t(o).attr("id")].droppedItem,delete this.dndData.objPosition[this.dndData.targetDiv.attr("id")].dropAt,this.dndData.targetDiv=void 0,this.dndData.containerDiv=void 0,this.prepareAndDispatchData(i,a,this.constants.DRAG_START),this.dndData.currentDraggable=a.helper,this.options.start.x=i.clientX,this.options.start.y=i.clientY},onDrag:function(t,i){this.prepareAndDispatchData(t,i,this.constants.DRAG);var a,o,n;1!==Number(this.options.updatedScale)&&(a=i.originalPosition.left+(t.clientX-this.options.start.x)/Number(this.options.updatedScale),o=i.originalPosition.top+(t.clientY-this.options.start.y)/this.options.updatedScale,n=this.containementCordinates(),a<n.left?a=n.left:a>n.right&&(a=n.right),o<n.top?o=n.top:o>n.bottom&&(o=n.bottom),i.position.left=a,i.position.top=o,this.options.currentPos={left:a,top:o})},containementCordinates:function(){var i,a,o,n;return void 0!==this.dndData.containment&&(i=0,a=0,o=i+this.dndData.containment.width()-t(this.dndData.currentDraggable).width(),n=a+this.dndData.containment.height()-t(this.dndData.currentDraggable).height()),{left:i,top:a,right:o,bottom:n}},onDragStop:function(i,a){void 0===this.dndData.containerDiv||void 0!==this.dndData.objPosition[this.dndData.containerDiv.attr("id")].droppedItem||void 0===this.dndData.bRevert||this.dndData.bRevert===!0?(t(a.helper).css("left",this.dndData.objPosition[t(a.helper).attr("id")].left),t(a.helper).css("top",this.dndData.objPosition[t(a.helper).attr("id")].top)):(this.dndData.objPosition[this.dndData.targetDiv.attr("id")].dropAt=this.dndData.containerDiv,this.dndData.objPosition[this.dndData.containerDiv.attr("id")].droppedItem=this.dndData.targetDiv,this.setPosition(this.dndData.targetDiv,this.dndData.containerDiv),this.dndData.targetDiv=void 0,this.dndData.containerDiv=void 0),this.dndData.bRevert=void 0},onDrop:function(i,a){var o,n;o=t(a.draggable),n=t(i.target),this.dndData.bRevert=!0,this.dndData.bRevert="droppable"===n.attr("type")?!1:!0,this.dndData.targetDiv=o,this.dndData.containerDiv=n,this.prepareAndDispatchData(i,a,this.constants.ON_DROP)},prepareAndDispatchData:function(t,i,a){var o={};o.objEvent=t,o.ui=t,this.dispatchEvent(a,{},o)},setPosition:function(i,a){var o,n;a=t(a),i=t(i),o=parseFloat(a.css("left"))+(a.innerWidth()-i.innerWidth())/2,n=parseFloat(a.css("top"))+(a.innerHeight()-i.innerHeight())/2,i.css("position","absolute"),i.css("left",o+"px"),i.css("top",n+"px")},checkAnswer:function(){var i,a,o,n,e={},s=this.options.widgetData.correctList;for(a=0;a<this.options.arrDraggableItem.length;a++){if(o=this.options.arrDraggableItem[a].id,void 0===this.dndData.objPosition[o].dropAt){i=!1;break}if(n=t(this.dndData.objPosition[o].dropAt).attr("id"),i=n===s[o],i===!1)break}for(e.isCorrect=i,e.correctList=[],e.incorrectList=[],a=0;a<this.options.arrDraggableItem.length;a++)o=this.options.arrDraggableItem[a].id,void 0!==this.dndData.objPosition[o].dropAt?(n=t(this.dndData.objPosition[o].dropAt).attr("id"),i=n===s[o],i===!1?e.incorrectList.push(o):e.correctList.push(o)):e.incorrectList.push(o);this.dispatchEvent(this.constants.ON_ANSWER_CHECKED,{},e)},freezeDnd:function(){var i;for(i=0;i<this.options.arrDraggableItem.length;i++)this.disableOption(t(this.options.arrDraggableItem[i]).attr("id"))},unfreezeDnd:function(){for(i=0;i<this.options.arrDraggableItem.length;i++)this.enableOption(t(this.options.arrDraggableItem[i]).attr("id"))},disableOption:function(i){var a=t("#"+i,this.options.parentDiv);void 0!==a?a.draggable("disable"):console.log(i+" not found.")},enableOption:function(i){var a=t("#"+i,this.options.parentDiv);void 0!==a?a.draggable("enable"):console.log(i+" not found.")},resetDnd:function(){var i,a,o=0;for(o=0;o<this.options.arrDropItem.length;o++)a=this.options.arrDropItem[o].id,delete this.dndData.objPosition[t(this.options.arrDropItem[o]).attr("id")].droppedItem;for(o=0;o<this.options.arrDraggableItem.length;o++)a=this.options.arrDraggableItem[o].id,i=t(this.options.arrDraggableItem[o]),i.css("left",this.dndData.objPosition[a].left),i.css("top",this.dndData.objPosition[a].top),delete this.dndData.objPosition[t(this.options.arrDraggableItem[o]).attr("id")].dropAt;this.dndData.targetDiv=void 0,this.dndData.containerDiv=void 0,this.dispatchEvent(this.constants.RESET_COMPLETE)},setStageScaleValue:function(t){this.options.updatedScale=Number(t)},destroy:function(){}})}(jQuery);