define(["marionette","components/audioplayer/source/js/audio-player"],function(t,e){var i={initComponent:function(t){this.objAudioPlayer=null,this.isPaused=!0,this.currentHotSpotTimeRange=void 0,this.currentHotSpot=void 0,this.currentIndex=0,this.reference=t,this.loadXML(this)},loadXML:function(){Data_Loader.on(Data_Loader.DATA_LOAD_SUCCESS,this.onXMLLoadSuccess,this),Data_Loader.on(Data_Loader.DATA_LOAD_FAILED,this.onXMLLoadFailure,this),Data_Loader.load({url:this.reference.model.get("xmlPath"),dataType:"xml",contentType:"application/xml",returnType:"json"})},onXMLLoadSuccess:function(t){var e,i,o,r;if(e=this.reference.model,Data_Loader.off(Data_Loader.DATA_LOAD_SUCCESS),Data_Loader.off(Data_Loader.DATA_LOAD_FAILED),void 0!==t.highlightClass.name&&e.set("highlightClass",t.highlightClass.name),i=[],t.audio.source instanceof Array)for(o=0;o<t.audio.source.length;o+=1)r=t.audio.source[o],i.push({path:r.src,type:r.type});else r=t.audio.source,i.push({path:r.src,type:r.type});e.set("audioSource",i),this.initAudioPlayer(),this.createHotSpots(t)},onXMLLoadFailure:function(){Data_Loader.off(Data_Loader.DATA_LOAD_SUCCESS),Data_Loader.off(Data_Loader.DATA_LOAD_FAILED),alert("xml failed to load.")},initAudioPlayer:function(){var t,i;t={},t.source=this.reference.model.get("audioSource"),t.loop=!1,i=new e(t),this.reference.model.set("audioPlayerRef",i),i.on(i.AUDIO_START_EVENT,this.onAudioEvent,this),i.on(i.AUDIO_PAUSE_EVENT,this.onAudioEvent,this),i.on(i.AUDIO_STOP_EVENT,this.onAudioEvent,this),i.on(i.AUDIO_FINISH_EVENT,this.onAudioEvent,this),this.objAudioPlayer=i},createHotSpots:function(t){var e,i,o,r,s,a,n,d;if(e=this.reference.model.get("map"),i="",t.par instanceof Array)for(o=t.par,r=0;r<o.length;r+=1){if(i+='<p id="',a=o[r],i=i+a.id+'" class="'+a.myClass+'">',a.word instanceof Array)for(n=a.word,s=0;s<n.length;s+=1)d=n[s],i=i+'<span id="'+d.id+'" class="'+d.myClass+'" >'+d.text+"</span> ",e.push({start:d.start,end:d.end,id:d.id});else d=a.word,i=i+'<span id="'+d.id+'" class="'+d.myClass+'"  >'+d.text+"</span> ",e.push({start:d.start,end:d.end,id:d.id});i+="</p>"}else{if(i+='<p id="',a=t.par,i=i+a.id+'" class="'+a.myClass+'">',t.par.word instanceof Array)for(n=t.par.word,s=0;s<n.length;s+=1)d=n[s],i=i+'<span id="'+d.id+'" class="'+d.myClass+'" >'+d.text+"</span> ",e.push({start:d.start,end:d.end,id:d.id});else d=t.par.word,i=i+'<span id="'+d.id+'" class="'+d.myClass+'" ">'+d.text+"</span> ",e.push({start:d.start,end:d.end,id:d.id});i+="</p>"}this.reference.model.set("strHotSpots",i)},applyEventOnHotSpots:function(){var t,e;t=this,e=this.reference.model.get("map"),_.each(e,function(e){$("#"+e.id).on("click",function(){t.objAudioPlayer.pause(),t.objAudioPlayer.setCurrentTime(e.start),t.objAudioPlayer.play()})})},onAudioEvent:function(t){var e;switch(t.type){case this.objAudioPlayer.AUDIO_START_EVENT:this.isPaused=!1,this.objAudioPlayer.off(this.objAudioPlayer.AUDIO_PROGRESS_EVENT),this.objAudioPlayer.on(this.objAudioPlayer.AUDIO_PROGRESS_EVENT,this.onAudioEvent,this);break;case this.objAudioPlayer.AUDIO_PROGRESS_EVENT:this.objAudioPlayer.off(this.objAudioPlayer.AUDIO_PROGRESS_EVENT),this.setCurrentIndexAndTimeRangeForCurrentTime(t.customData),this.startHotSpotHighlight(this.currentIndex);break;case this.objAudioPlayer.AUDIO_PAUSE_EVENT:this.isPaused=!0,this.interruptHotSpotHighlight();break;case this.objAudioPlayer.AUDIO_STOP_EVENT:case this.objAudioPlayer.AUDIO_FINISH_EVENT:this.isPaused=!0,this.interruptHotSpotHighlight(),void 0!==this.currentHotSpot&&(e=this.reference.model.get("highlightClass"),$(this.currentHotSpot).removeClass(e),this.currentHotSpot=void 0)}},setCurrentIndexAndTimeRangeForCurrentTime:function(t){var e,i,o,r;e=this.reference.model.get("map"),i=this,o=0,r=!1,_.each(e,function(e){e.end>t&&e.start<=t&&(i.currentHotSpotTimeRange=1e3*(e.end-t),i.currentIndex=o,r=!0),o+=1}),r||(this.currentIndex=-1)},startHotSpotHighlight:function(t){var e,i,o,r,s;e=this.reference.model.get("map"),s=this.reference.model.get("highlightClass"),i=0,r=this,_.each(e,function(e){i===t&&(o=1e3*(e.end-e.start),$("#"+e.id).addClass(s),r.currentIndex=i,r.currentHotSpot&&$(r.currentHotSpot).removeClass(s),r.currentHotSpot=$("#"+e.id),void 0!==r.currentHotSpotTimeRange&&(o=r.currentHotSpotTimeRange,r.currentHotSpotTimeRange=void 0),r.startHotSpotHighlightTimer=setTimeout(function(){r.hotSpotHighlightHelper(t)},o)),i+=1})},hotSpotHighlightHelper:function(){var t,e,i,o,r;return o=this,t=this.reference.model.get("map"),r=this.reference.model.get("highlightClass"),e=this.currentIndex,this.isPaused||(void 0!==this.currentHotSpot&&($(this.currentHotSpot).removeClass(r),this.currentHotSpot=void 0),e===t.length-1)?void 0:(i=this.objAudioPlayer.getCurrentTime(),this.setCurrentIndexAndTimeRangeForCurrentTime(i),-1===this.currentIndex?(this.startHotSpotHighlightTimer=setTimeout(function(){o.hotSpotHighlightHelper(this.currentIndex)},1),void 0):(this.startHotSpotHighlight(this.currentIndex),void 0))},interruptHotSpotHighlight:function(){this.startHotSpotHighlightTimer&&clearTimeout(this.startHotSpotHighlightTimer)},destroy:function(){this.objAudioPlayer.stop(),this.objAudioPlayer.off(this.objAudioPlayer.AUDIO_START_EVENT),this.objAudioPlayer.off(this.objAudioPlayer.AUDIO_PAUSE_EVENT),this.objAudioPlayer.off(this.objAudioPlayer.AUDIO_STOP_EVENT),this.objAudioPlayer.off(this.objAudioPlayer.AUDIO_FINISH_EVENT),this.objAudioPlayer.off(this.objAudioPlayer.AUDIO_PROGRESS_EVENT),this.objAudioPlayer.destroy(),clearTimeout(this.startHotSpotHighlightTimer),Data_Loader.off(Data_Loader.DATA_LOAD_SUCCESS),Data_Loader.off(Data_Loader.DATA_LOAD_FAILED),this.startHotSpotHighlightTimer=null,this.reference=null,this.objAudioPlayer=null,this.isPaused=!0,this.currentHotSpotTimeRange=void 0,this.currentHotSpot=void 0,this.currentIndex=0}};return i});