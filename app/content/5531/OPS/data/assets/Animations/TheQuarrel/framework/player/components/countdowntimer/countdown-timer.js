define(["marionette","player/base/base-item-comp","text!components/countdowntimer/template/countdown-timer.html","components/countdowntimer/model/countdown-timer-model","css!components/countdowntimer/template/css/countdown-timer.css"],function(e,t,o,r){var n=t.extend({template:_.template(o),heartbeatCounter:0,initialize:function(e){this.model=new r,this.renderDataParcel(e,this.model),this.model.on("change",$.proxy(this.onModelChange,this))},onShow:function(){this.$("#wrapper").addClass(this.model.get("countDownTimerWrapperStyle"))},renderDataParcel:function(e,t){var o,r;void 0!==e.countDownTimerWrapperStyle?e.countDownTimerWrapperStyle!==t.get("countDownTimerWrapperStyle")&&t.set("countDownTimerWrapperStyle",e.countDownTimerWrapperStyle):t.set("countDownTimerWrapperStyle","CountDownTimerWrapperStyle"),void 0!==e.decrementalCountDown&&(r="string"==typeof e.decrementalCountDown?"true"===e.decrementalCountDown?!0:!1:e.decrementalCountDown,t.get("decrementalCountDown")!==r&&t.set("decrementalCountDown",r)),void 0!==e.timerSeperator&&e.timerSeperator!==t.get("timerSeperator")&&t.set("timerSeperator",e.timerSeperator),void 0!==e.totalSeconds&&(o=parseInt(e.totalSeconds,10),o!==t.get("totalSeconds")&&t.set("totalSeconds",o)),void 0!==e.warningAfter&&e.warningAfter!==t.get("warningAfter")&&(o=parseInt(e.warningAfter,10),o<=t.get("totalSeconds")?t.set("warningAfter",o):alert("You are setting wrong values: warningAfter can't be higher than totalSeconds")),void 0!==e.timeFormat&&(o=parseInt(e.timeFormat,10),t.get("timeFormat")!==o&&t.set("timeFormat",o)),void 0!==e.dispatchHeartbeat&&(r="string"==typeof e.dispatchHeartbeat?"true"===e.dispatchHeartbeat?!0:!1:e.dispatchHeartbeat,t.get("dispatchHeartbeat")!==r&&t.set("dispatchHeartbeat",r)),void 0!==e.heratbeatTimeInterval&&(o=parseInt(e.heratbeatTimeInterval,10),o!==t.get("heratbeatTimeInterval")&&t.set("heratbeatTimeInterval",o)),t.get("decrementalCountDown")?t.set("timerData",this.getFormattedTime(t.get("totalSeconds"),t.get("timeFormat"))):t.set("timerData",this.getFormattedTime(0,t.get("timeFormat"))),console.log("parcel data:"+t.get("timeFormat"))},updateTimerView:function(e){e.model.get("isTimerPaused")||(e.model.get("decrementalCountDown")?e.decrementTimer(e):e.incrementTimer(e))},incrementTimer:function(e){if(e.model.get("secondsCounter")<=e.model.get("totalSeconds")){var t=e.model.get("secondsCounter");e.model.set("secondsCounter",++t),e.heartbeatCounter++,e.model.set("timerData",e.getFormattedTime(e.model.get("secondsCounter"),e.model.get("timeFormat"))),this.model.get("dispatchHeartbeat")&&e.heartbeatCounter===this.model.get("heratbeatTimeInterval")&&(e.heartbeatCounter=0,e.trigger(e.TIMER_HEARBEAT,this.model.get("timerData"))),e.model.get("secondsCounter")===e.model.get("warningAfter")&&e.trigger(e.TIMER_WARNING),e.model.get("secondsCounter")>e.model.get("totalSeconds")&&e.stopTimer()}},decrementTimer:function(e){if(e.model.get("secondsCounter")>=1){var t,o;t=e.model.get("secondsCounter"),e.model.set("secondsCounter",--t),e.heartbeatCounter++,e.model.set("timerData",e.getFormattedTime(e.model.get("secondsCounter"),e.model.get("timeFormat"))),this.model.get("dispatchHeartbeat")&&e.heartbeatCounter===this.model.get("heratbeatTimeInterval")&&(e.heartbeatCounter=0,e.trigger(e.TIMER_HEARBEAT,this.model.get("timerData"))),o=e.model.get("totalSeconds")-e.model.get("warningAfter"),e.model.get("secondsCounter")===o&&e.trigger(e.TIMER_WARNING),e.model.get("secondsCounter")<=0&&e.stopTimer()}},getFormattedTime:function(e,t){var o,r,n,i,s,a,m=function(e){return 10>e?"0"+e:e};return r=Math.floor(e/3600),n=e%3600,i=Math.floor(n/60),s=n%60,a=Math.ceil(s),0===t?o=m(r)+this.model.get("timerSeperator")+m(i)+this.model.get("timerSeperator")+m(a):1===t?o=m(i)+this.model.get("timerSeperator")+m(a):2===t&&(o=m(a)),o},checkTimerAvailability:function(e){e.model.get("decrementalCountDown")?e.model.get("secondsCounter")<=0&&e.stopTimer():e.model.get("secondsCounter")>=e.model.get("totalSeconds")&&e.stopTimer()},killTimer:function(e){e.model.set("isTimerPaused",!1),window.clearInterval(e.model.get("timerReference")),e.model.set("timerReference",null)},onModelChange:function(){this.$("#timer").html(this.model.get("timerData"))}});return n.prototype.Super=t,n.prototype.TIMER_HEARBEAT="timerHeartbeat",n.prototype.TIMER_FINISHED="timerFinished",n.prototype.TIMER_STARTED="timerStarted",n.prototype.TIMER_WARNING="timerWarning",n.prototype.TIMER_PAUSED="timerPaused",n.prototype.deductPenalty=function(e){this.model.get("decrementalCountDown")?this.model.set("secondsCounter",this.model.get("secondsCounter")-(e-1)):this.model.set("secondsCounter",this.model.get("secondsCounter")+(e-1)),this.checkTimerAvailability(this)},n.prototype.addBonus=function(e){if(this.model.get("decrementalCountDown"))this.model.set("secondsCounter",this.model.get("secondsCounter")+(e+1));else{var t=this.model.get("secondsCounter")-(e+1);t=0>t?0:t,this.model.set("secondsCounter",t)}},n.prototype.startTimer=function(){var e=this;this.model.get("timerReference")?console.log("Timer already running.\n Either pause the current timer and then resume it or stop the timer"):(this.model.set("secondsCounter",this.model.get("decrementalCountDown")?this.model.get("totalSeconds"):0),this.model.set("timerReference",window.setInterval(function(){e.updateTimerView(e)},this.model.get("DEFAULT_TICKING_TIME"))),this.trigger(this.TIMER_STARTED))},n.prototype.stopTimer=function(){this.killTimer(this),this.trigger(this.TIMER_FINISHED)},n.prototype.restartTimer=function(e){this.model.get("isTimerPaused")||this.model.set("isTimerPaused",!0),this.killTimer(this),void 0!==e&&this.model.set("totalSeconds",e),this.startTimer()},n.prototype.pauseTimer=function(){this.model.set("isTimerPaused",!0),this.trigger(this.TIMER_PAUSED)},n.prototype.resumeTimer=function(){this.model.set("isTimerPaused",!1)},n.prototype.flush=function(){this.model&&(this.model.id=null,this.model.destroy(),this.model=null)},n.prototype.destroy=function(){return this.flush(),this.unbind(),this.undelegateEvents(),this.close(),this.Super.prototype.destroy(!0)},n});